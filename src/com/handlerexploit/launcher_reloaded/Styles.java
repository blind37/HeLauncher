/* 
 * This program is free software. It comes without any warranty, to
 * the extent permitted by applicable law. You can redistribute it
 * and/or modify it under the terms of the Do What The Fuck You Want
 * To Public License, Version 2, as published by Sam Hocevar. See
 * http://sam.zoy.org/wtfpl/COPYING for more details.
 */

package com.handlerexploit.launcher_reloaded;

import java.io.IOException;

import android.app.Activity;
import android.app.Dialog;
import android.app.ProgressDialog;
import android.app.WallpaperManager;
import android.content.Intent;
import android.content.SharedPreferences.Editor;
import android.os.Bundle;
import android.os.Handler;
import android.view.GestureDetector;
import android.view.GestureDetector.OnDoubleTapListener;
import android.view.GestureDetector.OnGestureListener;
import android.view.MotionEvent;
import android.view.View;
import android.view.View.OnClickListener;
import android.widget.AdapterView;
import android.widget.AdapterView.OnItemLongClickListener;
import android.widget.Button;
import android.widget.Gallery;
import android.widget.ImageView;
import android.widget.TextView;

public class Styles extends Activity implements OnDoubleTapListener, OnGestureListener {
	private Gallery mGallery;
	private WallpaperManager mWallpaperManager;
	private GestureDetector gesturedetector = null;

    @Override
    public void onCreate(Bundle icicle) {
        super.onCreate(icicle);
        setContentView(R.layout.styles_main);
        
        gesturedetector = new GestureDetector(this, this);
        gesturedetector.setOnDoubleTapListener(this);
        
        mGallery = (Gallery) findViewById(R.id.gallery);
        mGallery.setAdapter(new StylesAdapter(this));
        mGallery.setOnItemLongClickListener(new OnItemLongClickListener() {
			@Override
			public boolean onItemLongClick(AdapterView<?> arg0, View arg1, int arg2, long arg3) {
				exit();
				return false;
			}
        });
        
        Button button = (Button)findViewById(R.id.apply);
        button.setOnClickListener(new OnClickListener() {
        	@Override
            public void onClick(View v) {
            	exit();
            }
        });
        
    	ImageView preferences = (ImageView) findViewById(R.id.preferences);
    	preferences.setOnClickListener(new OnClickListener() {
            public void onClick(View v) {
            	Intent i = new Intent(v.getContext(), Preferences.class);
            	v.getContext().startActivity(i);
            }
        });
    	
    	ImageView help_about = (ImageView) findViewById(R.id.help_about);
    	help_about.setOnClickListener(new OnClickListener() {
            public void onClick(View v) {
            	helpScreen(v).show();
            }
        });
    }
    
    private Dialog helpScreen(View v) {
    	Dialog d = new Dialog(v.getContext());
    	d.setContentView(R.layout.help_about);
    	d.setTitle("Custom Dialog");

    	TextView text = (TextView) d.findViewById(R.id.text);
    	text.setText("Hello, this is a custom dialog!");
    	
    	ImageView image = (ImageView) d.findViewById(R.id.image);
    	image.setImageResource(R.drawable.icon);
    	
    	return d;
    }
    
    private void wallpaperEditor(int wallpaper, int preferenceValue) { // Multi-tasking at its best
    	Editor editor = Styles.this.getSharedPreferences(Launcher.STYLE_PREF, 0).edit();
    	mWallpaperManager = WallpaperManager.getInstance(this);
    	        
        try {
			mWallpaperManager.setResource(wallpaper);
		} catch (IOException e) {}
		
    	editor.putInt(Launcher.PREFERENCE_STYLE , preferenceValue);
    	editor.commit();
    }
    
    private void exit() {
        int selectedPos = mGallery.getSelectedItemPosition();
        switch (selectedPos) {
        case 0:
        	wallpaperEditor(R.drawable.htc_wallpaper_14, 0);
        	break;
        case 1:
        	wallpaperEditor(R.drawable.htc_wallpaper_02, 1);
        	break;
        case 2:
        	wallpaperEditor(R.drawable.htc_wallpaper_01, 2);
        	break;
        case 3:
        	wallpaperEditor(R.drawable.htc_wallpaper_17, 3);
        	break;
        case 4:
        	wallpaperEditor(R.drawable.htc_wallpaper_06, 4);
        	break;
        case 5:
        	wallpaperEditor(R.drawable.htc_wallpaper_19, 5);
        	break;
        case 6:
        	wallpaperEditor(R.drawable.htc_wallpaper_10, 6);
        	break;
        case 7:
        	wallpaperEditor(R.drawable.htc_wallpaper_07, 7);
        	break;
        case 8:
        	wallpaperEditor(R.drawable.htc_wallpaper_12, 8);
        	break;
        }
        ProgressDialog.show(this, "", "Please wait...", true);
        new Handler().postDelayed(
        		new Runnable() {
        			@Override public void run() {
        				Styles.this.finish();
        				}
        			}, 500);
        /*
         * Generally, 100 to 200ms is the threshold beyond which users will perceive lag in an application.
         */
    }
    
    @Override
    public boolean onTouchEvent(MotionEvent event) {
            return gesturedetector.onTouchEvent(event);
    }

	@Override
	public boolean onDoubleTap(MotionEvent e) {
		exit();
		return false;
	}
	
	/* Land of the forgotten classes */
	
	public boolean onDoubleTapEvent(MotionEvent e) {return false;}
	public boolean onSingleTapConfirmed(MotionEvent e) {return false;}
	public boolean onDown(MotionEvent e) {return false;}
	public boolean onFling(MotionEvent e1, MotionEvent e2, float velocityX, float velocityY) {return false;}
	public void onLongPress(MotionEvent e) {}
	public boolean onScroll(MotionEvent e1, MotionEvent e2, float distanceX, float distanceY) {return false;}
	public void onShowPress(MotionEvent e) {}
	public boolean onSingleTapUp(MotionEvent e) {return false;}
}